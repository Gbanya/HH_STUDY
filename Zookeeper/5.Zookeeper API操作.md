## Zookeeper API操作

#### POM文件

```xml
<!-- Zookeeper -->
<dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
            <version>3.4.7</version>
        </dependency>
```

#### 连接操作

```java
@Test
public void connect() throws IOException, InterruptedException {
 
    CountDownLatch cdl = new CountDownLatch(1);
    // connectString - 连接地址+端口号
    // sessionTimeout - 会话超时时间 - 表示连接超时时间，单位默认为毫秒
    // watcher - 监控者 - 监控连接状态
    // Zookeeper本身是一个非阻塞式连接
    ZooKeeper zk = new ZooKeeper("117.50.90.232:2181", 5000, new Watcher() {
 
        // 监控连接状态
        public void process(WatchedEvent event) {
 
            if (event.getState() == KeeperState.SyncConnected) {
                System.out.println("连接成功~~~");
            }
            cdl.countDown();
        }
    });
    cdl.await();
 
}

```

#### 创建节点

```java
@Test
public void create() throws KeeperException, InterruptedException {
    // path - 节点路径
    // data - 数据
    // acl - acl策略
    // createMode - 节点类型
    // 返回值表示节点的实际路径
    String str = zk.create("/node08", "hello,1807".getBytes(), Ids.OPEN_ACL_UNSAFE,
            CreateMode.PERSISTENT_SEQUENTIAL);
    System.out.println(str);
 
}

```

#### 删除节点

```java
@Test
public void delete() throws InterruptedException, KeeperException {
 
    // path - 节点路径
    // version - 数据版本
    // 在删除节点的时候回比较指定的数据版本和节点的实际数据版本是否一致
    // 如果一致则删除，如果不一致则放弃该操作
    zk.delete("/node04", 0);
    // -1表示强制执行
    zk.delete("/node05", -1);
 
}
```

#### 更新节点数据

```java
@Test
public void set() throws KeeperException, InterruptedException{
    // path - 节点路径
    //data - 数据
    // version - 数据版本
    // 返回节点信息
    Stat s = zk.setData("/node02", "hi,zk".getBytes(), -1);
    System.out.println(s);
}
```

#### 获取节点的数据

```java
@Test
public void get() throws KeeperException, InterruptedException, UnsupportedEncodingException {
     
    // path - 节点路径
    // watch - 监控
    // stat - 节点信息
    Stat s =  new Stat();
    byte[] data = zk.getData("/node01", null, s );
    System.out.println(new String(data, "utf-8"));
     
}

```

#### 判断节点存在

```java
@Test
public void exist() throws KeeperException, InterruptedException{
     
    // path - 节点路径
    // watch - 监控者
    // 返回的节点的信息
    Stat s = zk.exists("/node07", null);
    System.out.println(s);
}

```

#### 获取子节点

```java
@Test
public void getChidren() throws KeeperException, InterruptedException {
     
    // path - 节点路径
    // watch - 监控者
    // 返回子节点的路径
    List<String> nodes = zk.getChildren("/" ,null);
    for (String p : nodes) {
        System.out.println(p);
    }
}

```

#### 监听节点数据变化

```java
 @Test
public void dataChanged() throws KeeperException, InterruptedException {
 
    CountDownLatch cdl = new CountDownLatch(1);
 
    // 获取的是监听之前的数据
    // 获取数据和监听变化实际上是两个线程
    byte[] data = zk.getData("/node01", new Watcher() {
 
        @Override
        public void process(WatchedEvent event) {
 
            if (event.getType() == EventType.NodeDataChanged)
                System.out.println("节点数据发生变化~~~");
            cdl.countDown();
        }
    }, null);
    cdl.await();
    System.out.println(new String(data));
 
}

```

#### 监听子节点是否发生变化

```java
 @Test
public void childChanged() throws KeeperException, InterruptedException {
 
    CountDownLatch cdl = new CountDownLatch(1);
 
    zk.getChildren("/node01", new Watcher() {
 
        @Override
        public void process(WatchedEvent event) {
            if (event.getType() == EventType.NodeChildrenChanged)
                System.out.println("子节点产生变化~~~");
            cdl.countDown();
        }
    });
    cdl.await();
 
}
```

#### 监听节点的变化

```java
 @Test
public void nodeChanged() throws KeeperException, InterruptedException {
 
    CountDownLatch cdl = new CountDownLatch(1);
 
    zk.exists("/node06", new Watcher() {
 
        @Override
        public void process(WatchedEvent event) {
 
            if (event.getType() == EventType.NodeCreated)
                System.out.println("这个节点被创建~~~");
            else if (event.getType() == EventType.NodeDeleted)
                System.out.println("这个节点被删除~~~");
            cdl.countDown();
        }
    });
 
    cdl.await();
 
}
```

